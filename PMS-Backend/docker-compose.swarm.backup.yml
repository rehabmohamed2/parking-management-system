# Docker Swarm Production Deployment Configuration
# Usage: docker stack deploy -c docker-compose.swarm.yml pms-backend
# Prerequisites:
#   1. Create external network: docker network create --driver overlay --attachable pms-network
#   2. Create secret: echo "YourStrong@Passw0rd" | docker secret create sa_password -
#   3. Build images: docker build -f Booking.API/Dockerfile -t wagihh/pms-booking-service:latest .
#                    docker build -f Invoice.API/Dockerfile -t wagihh/pms-invoice-service:latest .
#                    docker build -f Site.API/Dockerfile -t wagihh/pms-site-service:latest .
#
# Network Note: This uses overlay network (required for Swarm), not bridge like docker-compose.
# Service names (kafka, sqlserver) are used for DNS resolution - these match the original compose file.

version: '3.8'

# Shared environment configuration for .NET services
x-dotnet-environment: &dotnet-environment
  ASPNETCORE_ENVIRONMENT: Production
  ASPNETCORE_HTTP_PORTS: 8080
  Kafka__BootstrapServers: kafka:9092
  Kafka__Producer__Acks: all
  Kafka__Producer__MessageTimeoutMs: "30000"
  Kafka__Consumer__EnableAutoCommit: "false"
  Kafka__Consumer__AutoOffsetReset: earliest

# Shared service deployment configuration
# Note: networks must be defined at service level, not in deploy section
x-dotnet-service-deploy: &dotnet-service-deploy
  restart_policy:
    condition: any
    delay: 5s
    # max_attempts: 0 means unlimited in Docker Swarm
    max_attempts: 0
    window: 120s
  update_config:
    parallelism: 1
    delay: 10s
    failure_action: rollback
    order: start-first

services:
  # Kafka UI - Optional monitoring tool
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    ports:
      - "8090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    networks:
      - pms-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure

  # Zookeeper - Required for Kafka (single instance for Swarm)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    networks:
      - pms-network
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_log:/var/lib/zookeeper/log
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Kafka Message Broker (single instance for Swarm)
  # Note: depends_on is ignored in Swarm, rely on health checks and restart policies
  kafka:
    image: confluentinc/cp-kafka:7.6.0
    hostname: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
    networks:
      - pms-network
    volumes:
      - kafka_data:/var/lib/kafka/data
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 15s
      timeout: 15s
      retries: 10
      start_period: 60s

  # SQL Server Database
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    hostname: sqlserver
    ports:
      - "1433:1433"
    networks:
      - pms-network
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD_FILE: /run/secrets/sa_password
      MSSQL_PID: "Developer"
    secrets:
      - sa_password
    volumes:
      - sql_data:/var/opt/mssql
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$$(cat /run/secrets/sa_password)\" -C -Q \"SELECT 1\" || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  # Booking Service
  booking-service:
    image: omareldamaty/pms-booking-service:${IMAGE_TAG:-latest}
    networks:
      - pms-network
    ports:
      - "5001:8080"
    # Wait for Kafka and SQL Server DNS to be resolvable before starting
    entrypoint: >
      sh -c "
      echo 'Waiting for Kafka and SQL Server DNS resolution...';
      i=0;
      while [ $$i -lt 30 ]; do
        if getent hosts kafka > /dev/null 2>&1 && getent hosts sqlserver > /dev/null 2>&1; then
          echo 'Kafka and SQL Server DNS resolved, starting application...';
          break;
        fi;
        i=$$((i+1));
        echo \"Attempt $$i/30: Waiting for dependencies (Kafka/SQL Server), waiting 2s...\";
        sleep 2;
      done;
      exec dotnet Booking.API.dll
      "
    environment:
      <<: *dotnet-environment
      Kafka__ClientId: BookingService
      Kafka__Consumer__GroupId: BookingServiceGroup
      ConnectionStrings__DefaultConnection: "Server=sqlserver,1433;Database=PMS_Booking;User Id=sa;Password=YourStrong@Passw0rd;Encrypt=True;TrustServerCertificate=True;MultipleActiveResultSets=True;"
    secrets:
      - source: sa_password
        target: sa_password
        uid: '1000'
        gid: '1000'
        mode: 0400
    # Health check - TCP port check (same as Site service which is working)
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/8080' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 120s
    deploy:
      <<: *dotnet-service-deploy
      replicas: 2
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # Invoice Service
  invoice-service:
    image: omareldamaty/pms-invoice-service:${IMAGE_TAG:-latest}
    networks:
      - pms-network
    ports:
      - "5002:8080"
    # Wait for Kafka and SQL Server DNS to be resolvable before starting
    entrypoint: >
      sh -c "
      echo 'Waiting for Kafka and SQL Server DNS resolution...';
      i=0;
      while [ $$i -lt 30 ]; do
        if getent hosts kafka > /dev/null 2>&1 && getent hosts sqlserver > /dev/null 2>&1; then
          echo 'Kafka and SQL Server DNS resolved, starting application...';
          break;
        fi;
        i=$$((i+1));
        echo \"Attempt $$i/30: Waiting for dependencies (Kafka/SQL Server), waiting 2s...\";
        sleep 2;
      done;
      exec dotnet Invoice.API.dll
      "
    environment:
      <<: *dotnet-environment
      Kafka__ClientId: InvoiceService
      Kafka__Consumer__GroupId: InvoiceServiceGroup
      ConnectionStrings__DefaultConnection: "Server=sqlserver,1433;Database=PMS_Invoice;User Id=sa;Password=YourStrong@Passw0rd;Encrypt=True;TrustServerCertificate=True;MultipleActiveResultSets=True;"
    secrets:
      - source: sa_password
        target: sa_password
        uid: '1000'
        gid: '1000'
        mode: 0400
    # Health check - TCP port check (same as Site service which is working)
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/8080' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 120s
    deploy:
      <<: *dotnet-service-deploy
      replicas: 2
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # Site Service
  site-service:
    image: omareldamaty/pms-site-service:${IMAGE_TAG:-latest}
    networks:
      - pms-network
    ports:
      - "5003:8080"
    # Wait for Kafka and SQL Server DNS to be resolvable before starting
    entrypoint: >
      sh -c "
      echo 'Waiting for Kafka and SQL Server DNS resolution...';
      i=0;
      while [ $$i -lt 30 ]; do
        if getent hosts kafka > /dev/null 2>&1 && getent hosts sqlserver > /dev/null 2>&1; then
          echo 'Kafka and SQL Server DNS resolved, starting application...';
          break;
        fi;
        i=$$((i+1));
        echo \"Attempt $$i/30: Waiting for dependencies (Kafka/SQL Server), waiting 2s...\";
        sleep 2;
      done;
      exec dotnet Site.API.dll
      "
    environment:
      <<: *dotnet-environment
      Kafka__ClientId: SiteService
      Kafka__Consumer__GroupId: SiteServiceGroup
      ConnectionStrings__DefaultConnection: "Server=sqlserver,1433;Database=PMS_Site;User Id=sa;Password=YourStrong@Passw0rd;Encrypt=True;TrustServerCertificate=True;MultipleActiveResultSets=True;"
    secrets:
      - source: sa_password
        target: sa_password
        uid: '1000'
        gid: '1000'
        mode: 0400
    # Health check - TCP port check (no external tools needed)
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/8080' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 120s
    deploy:
      <<: *dotnet-service-deploy
      replicas: 2
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

networks:
  pms-network:
    external: true
    name: pms-network

volumes:
  zookeeper_data:
    name: pms_zookeeper_data
  zookeeper_log:
    name: pms_zookeeper_log
  kafka_data:
    name: pms_kafka_data
  sql_data:
    name: pms_sql_data

secrets:
  sa_password:
    external: true
    name: sa_password


